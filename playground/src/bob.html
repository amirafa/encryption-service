<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <title>üßë Bob ‚Äî Secure Messaging</title>
        <style>
            body {
                font-family: system-ui, sans-serif;
                background: #f6f6f9;
                margin: 2rem;
                max-width: 420px;
            }
            button,
            input,
            textarea {
                width: 100%;
                margin-top: 0.5rem;
            }
            .fingerprint {
                font-family: monospace;
                background: #eee;
                padding: 0.4rem;
                border-radius: 4px;
                word-break: break-all;
            }
            .ok {
                color: green;
            }
            .warn {
                color: red;
            }
            #chat {
                width: 100%;
                height: 160px;
                margin-top: 1rem;
            }
        </style>
    </head>
    <body>
        <h2>üîê Bob</h2>

        <button id="gen-id">Generate Identity Keys</button>
        <button id="gen-ecdh">Generate ECDH Keys</button>

        <h4>My Fingerprint</h4>
        <div id="fp" class="fingerprint">‚Äî</div>

        <h4>Verify Alice‚Äôs Fingerprint</h4>
        <input id="entered-fp" placeholder="Paste Alice‚Äôs fingerprint" />
        <button id="confirm-fp">Confirm</button>
        <div id="result"></div>

        <hr />
        <textarea id="msg" placeholder="Message to Alice..."></textarea>
        <button id="send">Send ‚û°Ô∏è Alice</button>
        <button id="read">üì• Read Last Message</button>

        <h4>Chat Log</h4>
        <textarea id="chat" readonly></textarea>

        <script type="module">
            import { EncryptionService } from "./node_modules/encryption-service/dist/encryption-service.es.js";
            const svc = EncryptionService({ isolated: true });
            const chatBox = document.getElementById("chat");

            function formatFp(hex) {
                return (hex.match(/.{1,4}/g) || [hex]).join(":");
            }

            async function getFp(name) {
                const pub = localStorage.getItem(`${name}-id-publicKey`);
                if (!pub) return null;
                const key = await svc.importIdentityPublicKey(pub);
                return await svc.getIdentityFingerprint(key);
            }

            async function refreshFp() {
                const fp = await getFp("bob");
                document.getElementById("fp").textContent = fp
                    ? formatFp(fp)
                    : "‚Äî";
            }

            async function getKeys(name) {
                return {
                    idPriv: localStorage.getItem(`${name}-id-privateKey`),
                    ecdhPriv: localStorage.getItem(`${name}-privateKey`),
                    ecdhPub: localStorage.getItem(`${name}-publicKey`),
                };
            }

            // Generate Keys
            document.getElementById("gen-id").onclick = async () => {
                await svc.generateAndStoreIdentityKeyPair("bob");
                await refreshFp();
                alert("‚úÖ Bob identity keys ready.");
            };
            document.getElementById("gen-ecdh").onclick = async () => {
                await svc.generateAndStoreECDHKeyPair("bob");
                alert("‚úÖ Bob ECDH keys ready.");
            };

            // Verify Alice fingerprint
            document.getElementById("confirm-fp").onclick = async () => {
                const entered = document
                    .getElementById("entered-fp")
                    .value.replace(/\s|:/g, "")
                    .toLowerCase();
                const real = await getFp("alice");
                const res = document.getElementById("result");
                if (!real)
                    return (
                        (res.textContent = "‚ö†Ô∏è No Alice key yet."),
                        (res.className = "warn")
                    );
                if (entered === real)
                    (res.textContent = "‚úÖ MATCH ‚Äî verified."),
                        (res.className = "ok");
                else
                    (res.textContent = "‚ö†Ô∏è MISMATCH ‚Äî possible MITM."),
                        (res.className = "warn");
            };

            // Send Message
            document.getElementById("send").onclick = async () => {
                const message = document.getElementById("msg").value.trim();
                if (!message) return alert("Enter a message first!");

                const bob = await getKeys("bob");
                const alicePub = localStorage.getItem("alice-publicKey");
                if (!alicePub) return alert("‚ö†Ô∏è No Alice ECDH key.");

                const priv = await svc.importPrivateKey(bob.ecdhPriv);
                const pub = await svc.importPublicKey(alicePub);
                const sharedKey = await svc.deriveSharedKey(priv, pub);

                const { encryptedMessage, iv } = await svc.encryptMessageAES(
                    message,
                    sharedKey
                );

                localStorage.setItem(
                    "msg-to-alice",
                    svc.arrayBufferToBase64(encryptedMessage)
                );
                localStorage.setItem(
                    "iv-to-alice",
                    svc.arrayBufferToBase64(iv)
                );

                chatBox.value += `[Bob ‚Üí Alice] ${message}\n`;
                document.getElementById("msg").value = "";
            };

            // Read Message from Alice
            document.getElementById("read").onclick = async () => {
                const enc = localStorage.getItem("msg-to-bob");
                const iv = localStorage.getItem("iv-to-bob");
                if (!enc || !iv) return alert("üì≠ No new message from Alice.");

                const alicePub = localStorage.getItem("alice-publicKey");
                const bobPriv = localStorage.getItem("bob-privateKey");
                if (!alicePub || !bobPriv) return alert("‚ö†Ô∏è Missing keys.");

                const priv = await svc.importPrivateKey(bobPriv);
                const pub = await svc.importPublicKey(alicePub);
                const sharedKey = await svc.deriveSharedKey(priv, pub);

                const msg = await svc.decryptMessageAES(
                    svc.base64ToArrayBuffer(enc),
                    sharedKey,
                    new Uint8Array(svc.base64ToArrayBuffer(iv))
                );

                chatBox.value += `[Alice ‚Üí Bob] ${msg}\n`;
            };

            refreshFp();
        </script>
    </body>
</html>
